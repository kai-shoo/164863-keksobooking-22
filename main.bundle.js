(()=>{"use strict";const e=async function(e,t){const o=t?fetch(e,{method:"POST",body:t}):fetch(e),n=await Promise.race([o,(1e4,new Promise((function(e,t){setTimeout((function(){t(new Error("Запрос выполняется слишком долго! Прервано после 10000 секунд"))}),1e4)})))]);const r=await n.json();if(!n.ok)throw new Error(`${r.message} (${n.status})`);return r},t="https://22.javascript.pages.academy/keksobooking",o={},n=35.6817,r=139.753882,a=document.querySelector("#map-canvas"),i=document.querySelector(".map__filters-container"),c=function(){u.setView({lat:n,lng:r},10)},u=function(){const e=L.map(a);return L.tileLayer("https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}).addTo(e),e}(),s=L.marker({lat:n,lng:r},{draggable:!0}),l=L.featureGroup().addTo(u),d="100",f=["gif","jpg","jpeg","png"],p={bungalow:0,flat:1e3,house:5e3,palace:1e4},m=document.querySelector(".ad-form"),y=document.querySelectorAll(".ad-form__element"),v=document.querySelector(".map__filters"),g=document.querySelectorAll(".map__filter"),h=document.querySelector(".map__features"),b=document.querySelector("#title"),S=document.querySelector("#address"),_=document.querySelector("#type"),q=document.querySelector("#price"),w=document.querySelector("#timein"),E=document.querySelector("#timeout"),C=document.querySelector("#avatar"),$=document.querySelector(".ad-form-header__preview > img"),j=document.querySelector("#images"),x=document.querySelector(".ad-form__photo > img"),A=document.querySelector("#capacity"),T=A.querySelectorAll("option"),V=document.querySelector("#room_number"),k=document.querySelector(".ad-form__reset"),O=function(e){const t=this.files[0];console.log(t);const o=t.name.toLowerCase();if(f.some((e=>o.endsWith(e)))){const o=new FileReader;o.addEventListener("load",(()=>{e.setAttribute("width","40"),e.setAttribute("height","44"),e.src=o.result})),o.readAsDataURL(t)}},D=function(){b.setCustomValidity(""),b.validity.valid||(b.validity.tooShort&&b.setCustomValidity("Заголовок должнен состоять минимум из 30-ти символов"),b.validity.tooLong&&b.setCustomValidity("Заголовок не должен превышать 100 символов"),b.validity.valueMissing&&b.setCustomValidity("Обязательное поле"),b.reportValidity())},M=function(){T.forEach((e=>{V.value===d&&(e.disabled="0"!==e.value),V.value!==d&&(e.disabled=V.value<e.value,"0"===e.value&&(e.disabled=!0)),A.value===e.value&&(A.dataset.isDisabled=e.disabled)}))},N=function(){"true"===A.dataset.isDisabled&&(A.setCustomValidity("Комнат должно быть больше или столько же сколько гостей"),V.value===d&&A.setCustomValidity('100 комнат может быть только "для не гостей"'),A.reportValidity()),"false"===A.dataset.isDisabled&&A.setCustomValidity("")},F=function(e){k.addEventListener("click",e)},P=function(){q.setCustomValidity(""),q.validity.valid||(q.validity.rangeUnderflow&&q.setCustomValidity(`Цена не должна быть меньше ${q.getAttribute("min")}`),q.validity.rangeOverflow&&q.setCustomValidity("Цена не должна превышать 1000000"),q.validity.valueMissing&&q.setCustomValidity("Обязательное поле"),q.validity.badInput&&q.setCustomValidity("Цена должна быть числом"),q.reportValidity())},U=function(){m.classList.toggle("ad-form--disabled"),y.forEach((e=>e.disabled=!e.disabled)),v.classList.toggle("map__filters--disabled"),h.disabled=!h.disabled,g.forEach((e=>e.disabled=!e.disabled))},z=function(){m.reset()};U(),S.setAttribute("readonly","readonly"),M(),_.addEventListener("change",(()=>{const e=_.value,t=p[e];q.setAttribute("min",t),q.setAttribute("placeholder",t),P()})),[w,E].forEach((e=>e.addEventListener("change",(()=>{w.value=E.value=e.value})))),b.addEventListener("focus",D),b.addEventListener("input",D),q.addEventListener("input",P),q.addEventListener("focus",P),V.addEventListener("change",(()=>{M(),N()})),A.addEventListener("change",(()=>{M(),N()})),F(),C.addEventListener("change",O.bind(C,$)),j.addEventListener("change",O.bind(j,x));const I={iconUrl:"./img/main-pin.svg",iconSize:[25,41],iconAnchor:[12,41]},W={iconUrl:"./img/pin.svg",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[0,-31]},H=function(e){e.forEach((e=>{const{lat:t,lng:o}=e.location;R(t,o).addTo(l)}))},R=function(e,t){return L.marker({lat:e,lng:t},{icon:L.icon(W)})},G={flat:"Квартира",bungalow:"Бунгало",house:"Дом",palace:"Дворец"},B=document.querySelector("#card").content.querySelector(".popup"),J=function(e){const t=document.querySelector(`#${e}`).content.querySelector(`.${e}`),o=document.createDocumentFragment();o.appendChild(t.cloneNode(!0)),document.querySelector("main").appendChild(o);const n=document.querySelector(`.${e}`);n.focus(),n.addEventListener("click",(()=>{document.querySelector(`.${e}`).remove()})),n.addEventListener("keydown",(function(t){"Escape"===t.key&&document.querySelector(`.${e}`).remove()}))},K=document.querySelector(".map__filters"),Q=document.querySelector("#housing-type"),X=document.querySelector("#housing-rooms"),Y=document.querySelector("#housing-guests"),Z=document.querySelector("#housing-price"),ee=document.querySelector("#housing-features"),te={any:[0],low:[0,1e4],middle:[1e4,5e4],high:[5e4]},oe=function(){K.reset()},ne=function(e){var t=typeof e;return null!=e&&("object"==t||"function"==t)},re="object"==typeof global&&global&&global.Object===Object&&global;var ae="object"==typeof self&&self&&self.Object===Object&&self;const ie=re||ae||Function("return this")(),ce=function(){return ie.Date.now()};var ue=/\s/;var se=/^\s+/;const le=function(e){return e?e.slice(0,function(e){for(var t=e.length;t--&&ue.test(e.charAt(t)););return t}(e)+1).replace(se,""):e},de=ie.Symbol;var fe=Object.prototype,pe=fe.hasOwnProperty,me=fe.toString,ye=de?de.toStringTag:void 0;var ve=Object.prototype.toString;var ge=de?de.toStringTag:void 0;const he=function(e){return null==e?void 0===e?"[object Undefined]":"[object Null]":ge&&ge in Object(e)?function(e){var t=pe.call(e,ye),o=e[ye];try{e[ye]=void 0;var n=!0}catch(e){}var r=me.call(e);return n&&(t?e[ye]=o:delete e[ye]),r}(e):function(e){return ve.call(e)}(e)};var be=/^[-+]0x[0-9a-f]+$/i,Se=/^0b[01]+$/i,_e=/^0o[0-7]+$/i,qe=parseInt;const Le=function(e){if("number"==typeof e)return e;if(function(e){return"symbol"==typeof e||function(e){return null!=e&&"object"==typeof e}(e)&&"[object Symbol]"==he(e)}(e))return NaN;if(ne(e)){var t="function"==typeof e.valueOf?e.valueOf():e;e=ne(t)?t+"":t}if("string"!=typeof e)return 0===e?e:+e;e=le(e);var o=Se.test(e);return o||_e.test(e)?qe(e.slice(2),o?2:8):be.test(e)?NaN:+e};var we=Math.max,Ee=Math.min;var Ce;Ce=function(){},window.addEventListener("DOMContentLoaded",Ce),function(e){window.addEventListener("DOMContentLoaded",e)}((function(){c(),s.setIcon(L.icon(I)).addTo(u),U()})),function(e){l.on("click",e)}((function(e){const t=e.propagatedFrom,n=o.ads.find((e=>{if(e.location.lat===t.getLatLng().lat&&e.location.lng===t.getLatLng().lng)return!0}));!function(e,t){const o=function(e){const t=document.createDocumentFragment(),o=B.cloneNode(!0);o.querySelector(".popup__avatar").src=e.author.avatar,o.querySelector(".popup__title").textContent=e.offer.title,o.querySelector(".popup__text--address").textContent=e.offer.address,o.querySelector(".popup__text--price").textContent=e.offer.price,o.querySelector(".popup__type").textContent=G[e.offer.type],o.querySelector(".popup__text--capacity").textContent=`${e.offer.rooms} комнаты для ${e.offer.guests} гостей.`,o.querySelector(".popup__text--time").textContent=`Заезд после ${e.offer.checkin}, выезд до ${e.offer.checkout}`;const n=o.querySelectorAll(".popup__feature");if(0===e.offer.features&&n.remove(),0!==e.offer.features.length){const t=e.offer.features.map((e=>`popup__feature popup__feature--${e}`));r=t,n.forEach((e=>{r.some((t=>e.className.includes(`${t}`)))||e.remove()}))}var r;o.querySelector(".popup__description").textContent=e.offer.description;const a=o.querySelector(".popup__photo");a.remove();const i=o.querySelector(".popup__photos");return e.offer.photos.forEach((e=>{const t=a.cloneNode();t.src=`${e}`,i.appendChild(t)})),t.append(o),t}(t);e.bindPopup(o).togglePopup(),e.unbindPopup()}(t,n)})),function(e){s.on("move add",e)}((function(){const e=s.getLatLng();console.log("atata"),function(e){const{lat:t,lng:o}=e;S.value=`${t.toFixed(5)}, ${o.toFixed(5)}`}(e)})),function(e){u.on("load",e)}((async function(){try{await async function(){try{const n=await e(`${t}/data`);o.ads=n}catch(e){throw e}}();const n=o.ads.slice(0,10);H(n)}catch(e){i.innerHTML="",i.insertAdjacentHTML("afterbegin",'\n    <div class="error__message-marker">\n      <p>Ошибка загрузки!</p>\n    </div>')}})),function(e){m.addEventListener("submit",e)}((async function(o){try{o.preventDefault();const a=new FormData(o.target);await function(o){try{return e(t,o)}catch(e){throw e}}(a);const i={lat:n,lng:r};J("success"),z(),oe(),c(),s.setLatLng(i)}catch(e){J("error")}})),F((function(){c(),z(),oe(),s.setLatLng({lat:n,lng:r})})),function(e){K.addEventListener("change",e),K.addEventListener("reset",e)}(function(e,t,o){var n,r,a,i,c,u,s=0,l=!1,d=!1,f=!0;if("function"!=typeof e)throw new TypeError("Expected a function");function p(t){var o=n,a=r;return n=r=void 0,s=t,i=e.apply(a,o)}function m(e){return s=e,c=setTimeout(v,t),l?p(e):i}function y(e){var o=e-u;return void 0===u||o>=t||o<0||d&&e-s>=a}function v(){var e=ce();if(y(e))return g(e);c=setTimeout(v,function(e){var o=t-(e-u);return d?Ee(o,a-(e-s)):o}(e))}function g(e){return c=void 0,f&&n?p(e):(n=r=void 0,i)}function h(){var e=ce(),o=y(e);if(n=arguments,r=this,u=e,o){if(void 0===c)return m(u);if(d)return clearTimeout(c),c=setTimeout(v,t),p(u)}return void 0===c&&(c=setTimeout(v,t)),i}return t=Le(t)||0,ne(o)&&(l=!!o.leading,a=(d="maxWait"in o)?we(Le(o.maxWait)||0,t):a,f="trailing"in o?!!o.trailing:f),h.cancel=function(){void 0!==c&&clearTimeout(c),s=0,n=u=r=c=void 0},h.flush=function(){return void 0===c?i:g(ce())},h}((function(){const e=function(){const e=Array.from(ee.querySelectorAll(":checked")).map((e=>e.value));return{price:te[Z.value],type:Q.value,rooms:X.value,guests:Y.value,features:e}}(),t=(n=e,o.ads.filter((e=>(!e.offer.type||e.offer.type===n.type||"any"===n.type)&&(!e.offer.rooms||e.offer.rooms===+n.rooms||"any"===n.rooms)&&(!e.offer.guests||e.offer.guests===+n.guests||"any"===n.guests)&&(!e.offer.price||!(e.offer.price<n.price[0]||e.offer.price>n.price[1]))&&(0===e.offer.features.length||0===n.features.length||n.features.every((t=>e.offer.features.includes(t))))))).slice(0,10);var n;l.clearLayers(),u.closePopup(),c(),H(t)}),500))})();
//# sourceMappingURL=main.bundle.js.map